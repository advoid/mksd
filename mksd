#!/bin/bash

# Written 2015 by Johannes Findeisen <you@hanez.org>
# Licensed under the terms of the GPLv2 license.

# This is actually just a place for brainstorming stuff...

# This needs to run as root!!! I don't use sudo here.

# 1. Partition SD card
# 2. Format partitions
# 3. wget Gentoo and extract it to / partition
# 4. wget Raspbian Kernel and extract it to /boot partition
# 5. Configure the Gentoo OS
# 5.1 Network configuaration / enable eth0
# 5.2 ...
# 6. 

DEVICE=/dev/mmcblk0

mkdir tmp

# Create partitions:
echo -e "d\n\nd\n\nd\no\nn\np\n1\n\n+100M\nn\np\n2\n\n+3200M\nn\np\n3\n\n\nw" | fdisk ${DEVICE}

# Prepare filesystems:
mkfs.msdos -F 32 ${DEVICE}p1 -n ADVOID_BOOT
mke2fs -F -t ext4 ${DEVICE}p2 -L ADVOID_ROOT
mkswap ${DEVICE}p3

# Mount filesystems:
mkdir /tmp/advoid
mount ${DEVICE}p2 /tmp/advoid
mkdir /tmp/advoid/boot
mount ${DEVICE}p1 /tmp/advoid/boot

# Extract Gentoo
# TODO!

# Install kernel
#cd /tmp/
#git clone --depth 1 git://github.com/raspberrypi/firmware/
#cd firmware/boot
#cp * /tmp/advoid/boot/
#cp -r ../modules /tmp/advoid/lib/ 

# Configure the system:

mkdir /tmp/advoid/etc

cat << EOF > /tmp/advoid/etc/fstab
/dev/mmcblk0p1      /boot       auto        noauto,noatime  1 2
/dev/mmcblk0p2      /           ext4        noatime         0 1
/dev/mmcblk0p3      none        swap        sw              0 0
EOF

touch /tmp/advoid/boot/test.touch

# ...

# Cleanup:
umount /tmp/advoid/boot
umount /tmp/advoid
rm -rf /tmp/advoid

